// 🔑 Tu API Key de Mapbox
mapboxgl.accessToken = 'pk.eyJ1IjoidWJhdGUyMDI1IiwiYSI6ImNtZ3Z0ZGdwYjB1ZDcyam9lZzcwdzRwcmUifQ.stEGy4XrEA9X8hdztUISyw';

// 🔗 Conexión con Supabase
const supabaseUrl = 'https://arpartnlablfedsqxbsz.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycGFydG5sYWJsZmVkc3F4YnN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxODU5MzQsImV4cCI6MjA2OTc2MTkzNH0.Vg5bkYt0ON_-WAM2-Ftq4x_i67yizI39FkGxuBWxTWs';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let map;
let marcadores = [];

// COORDENADAS CUENCA COMPLETA
const coordenadasCuencaCompleta = [
  [-73.71232032267025, 5.525239623679089],
  [-73.71839010436159, 5.518881750848288],
  [-73.72724582027502, 5.518583473341114],
  [-73.73687518934425, 5.509958070252361],
  [-73.74041685714788, 5.503261537905799],
  [-73.74318739512634, 5.498883673159821],
  [-73.74850025655438, 5.494107724954747],
  [-73.7553293456681, 5.490898152112016],
  [-73.75895141408132, 5.488332240656552],
  [-73.76314029263477, 5.485346642925314],
  [-73.76568829979311, 5.481862165964272],
  [-73.76580193577476, 5.477455340767648],
  [-73.76622889433327, 5.477064995506601],
  [-73.76807079121178, 5.474346328870812],
  [-73.76828525290351, 5.473664287601592],
  [-73.77021458590248, 5.470772607662384],
  [-73.76981160748538, 5.469217657541133],
  [-73.76973663253594, 5.468744177034348],
  [-73.7692836967617, 5.466873685839845],
  [-73.76915880791414, 5.466084850515268],
  [-73.7689293214479, 5.464667098464111],
  [-73.76916319150044, 5.461942926400943],
  [-73.78435732644574, 5.442463435791775],
  [-73.7892364169426, 5.435634104828744],
  [-73.78836256407661, 5.430082119999561],
  [-73.78522506426664, 5.425696172278355],
  [-73.79057915504393, 5.417015017378691],
  [-73.79745974519075, 5.409775908725199],
  [-73.80209198687474, 5.404030733112462],
  [-73.80767732405965, 5.402051676266447],
  [-73.81344000049016, 5.397222633855327],
  [-73.81358338151021, 5.39193062419742],
  [-73.81717422484047, 5.38228737833824],
  [-73.82388355218012, 5.375317505788728],
  [-73.82783875433486, 5.370203398899017],
  [-73.83922903242774, 5.370512539647531],
  [-73.87166876360085, 5.396255813258636],
  [-73.87329979237583, 5.396043792531245],
  [-73.88929810274006, 5.379468120156027],
  [-73.9016341078588, 5.380736159371223],
  [-73.91208512409115, 5.380813887171745],
  [-73.92631043353019, 5.365220337596343],
  [-73.94089865128466, 5.376148267371591],
  [-73.94511847155945, 5.374544366934927],
  [-73.94754986844825, 5.373925610560305],
  [-73.95112252727814, 5.372858152056813],
  [-73.9545460887191, 5.363051976431113],
  [-73.95991418773369, 5.358705040765663],
  [-73.9629891668344, 5.358522840492736],
  [-73.97465272043399, 5.34427048781119],
  [-73.98059816551691, 5.33410561181987],
  [-73.98103054339987, 5.320546519289985],
  [-73.97883207481745, 5.31728455971845],
  [-73.97604528113581, 5.316612463812953],
  [-73.96535823442838, 5.301552031610072],
  [-73.96680206435445, 5.298742178001216],
  [-73.97122386815357, 5.29945431302979],
  [-73.97803524414866, 5.293447562912831],
  [-73.97823014803518, 5.289593756383936],
  [-73.97698795322557, 5.287666663537435],
  [-73.97737021964016, 5.282769983050375],
  [-73.97080362453264, 5.275926263795429],
  [-73.97214302818386, 5.272835821418336],
  [-73.97383735548587, 5.264930248302646],
  [-73.9731422448787, 5.263670381576361],
  [-73.97754190051357, 5.251761917062296],
  [-73.9821647444177, 5.252484391120912],
  [-73.98593179529151, 5.242896768075917],
  [-73.99055217129379, 5.241291793281743],
  [-73.9926624699642, 5.232678796407995],
  [-73.98858306165968, 5.229719685913865],
  [-73.98094203967139, 5.225603916617763],
  [-73.98123578040364, 5.222747364546788],
  [-73.97823873715058, 5.22056427673524],
  [-73.97762639256021, 5.217308709189988],
  [-73.97402287776274, 5.214886942424513],
  [-73.97328368903247, 5.210682221177055],
  [-73.95582492242814, 5.21635062920393],
  [-73.95035110018287, 5.225317538561451],
  [-73.94696322162429, 5.222659230159632],
  [-73.94546265570364, 5.229164467193709],
  [-73.94355818020655, 5.23279960539131],
  [-73.93716941734949, 5.234693296554529],
  [-73.9208718385181, 5.230354874134576],
  [-73.91751127529443, 5.222836970817688],
  [-73.91011346113241, 5.213909457193164],
  [-73.9057384525839, 5.21311272115451],
  [-73.90592528912975, 5.21124337011836],
  [-73.90810140355269, 5.210198501987716],
  [-73.91331107203524, 5.207481015615052],
  [-73.91397218877695, 5.20409256392206],
  [-73.92153690925535, 5.196945650415586],
  [-73.92154846296054, 5.188853463484713],
  [-73.91786883308595, 5.186117041380575],
  [-73.91326096730269, 5.18596593190267],
  [-73.90714382549049, 5.17578541426731],
  [-73.90207623980227, 5.175190409244851],
  [-73.87401409254032, 5.182936762017651],
  [-73.85916264286938, 5.191650755915016],
  [-73.85099235533546, 5.195434905994095],
  [-73.84617297526505, 5.195412923589773],
  [-73.8330207753301, 5.201930367505152],
  [-73.82604396534279, 5.208229618240405],
  [-73.82483357380065, 5.210140724531414],
  [-73.82128988669909, 5.213093511425671],
  [-73.81803723175958, 5.213402374391629],
  [-73.81440406970367, 5.20836197121604],
  [-73.81084048268275, 5.203383915990014],
  [-73.80739575427882, 5.19939752960443],
  [-73.8017484675467, 5.200925849701942],
  [-73.79672961658153, 5.202764661500106],
  [-73.79325076445745, 5.20609390030393],
  [-73.78289971671008, 5.205545839185519],
  [-73.78058422467413, 5.209432941749051],
  [-73.77773423593749, 5.210243082375004],
  [-73.77384745290551, 5.214761381464476],
  [-73.76841434446503, 5.212869331640577],
  [-73.762338671995, 5.215778675229426],
  [-73.75789697112002, 5.214514669644561],
  [-73.76386636026734, 5.204335070895856],
  [-73.76463850429678, 5.203077311777714],
  [-73.76278094747566, 5.201859596192928],
  [-73.76324708474698, 5.195602127894847],
  [-73.77038501177677, 5.188186315884044],
  [-73.77965581208291, 5.177091089652513],
  [-73.78529668603697, 5.171322557509492],
  [-73.78718142827502, 5.166854917522948],
  [-73.79092311754663, 5.158780160857335],
  [-73.79006519285976, 5.156517702058184],
  [-73.78644504760601, 5.151613151134468],
  [-73.78536724180189, 5.141464801561074],
  [-73.78381988457417, 5.13800569787683],
  [-73.77502036919333, 5.136368194723877],
  [-73.77330403760868, 5.137484482621448],
  [-73.75948546041059, 5.164295435684969],
  [-73.75442275589566, 5.16611884195977],
  [-73.75126857555578, 5.178053845264926],
  [-73.74095182649164, 5.181334908855747],
  [-73.73640424111449, 5.18185604795492],
  [-73.72460147147446, 5.18917112199322],
  [-73.72435802680762, 5.191595508594973],
  [-73.72011317710353, 5.197456134579395],
  [-73.71442918164551, 5.190920977623898],
  [-73.70499093377336, 5.186115259004529],
  [-73.69632978500526, 5.192029488102095],
  [-73.6909435062787, 5.191388946026894],
  [-73.68627359606477, 5.195778488565945],
  [-73.68214844730478, 5.195387593430633],
  [-73.67965678096233, 5.196504391760531],
  [-73.68362561379837, 5.20255779473405],
  [-73.68442932704517, 5.207280368714639],
  [-73.68472553842935, 5.210028969925208],
  [-73.68167692196099, 5.213160434161519],
  [-73.68069418351881, 5.218521657701741],
  [-73.67056995163605, 5.219739175943714],
  [-73.66629800274762, 5.227130107349534],
  [-73.65632215099116, 5.233257705783567],
  [-73.65044072365548, 5.233392076263674],
  [-73.64381722618326, 5.242387768595496],
  [-73.63661136563027, 5.252356941615001],
  [-73.62994534729083, 5.248812553097565],
  [-73.61940069203369, 5.259526440527773],
  [-73.59917374608322, 5.2709321751722],
  [-73.58393614888524, 5.286647489763801],
  [-73.5830703843237, 5.286841366376735],
  [-73.57854777954802, 5.303446154656609],
  [-73.58132796124801, 5.316642905368116],
  [-73.57707595901461, 5.335111073475755],
  [-73.57613580671878, 5.336816741988902],
  [-73.57622383564518, 5.337433006317738],
  [-73.57783402200093, 5.355330986660155],
  [-73.58068824669252, 5.369069626900813],
  [-73.56295103487875, 5.386835398126006],
  [-73.55957328053039, 5.390551089259493],
  [-73.57901039225764, 5.400726087871106],
  [-73.58372425026808, 5.406569833366246],
  [-73.58638262598183, 5.407385887505945],
  [-73.59684097442155, 5.405728563318021],
  [-73.60153788278592, 5.405437300531051],
  [-73.60471172975259, 5.412886641196618],
  [-73.6281395888771, 5.428620417372017],
  [-73.63673403998612, 5.44526860247479],
  [-73.62384201902292, 5.462832606882109],
  [-73.62640217353916, 5.464451889217593],
  [-73.63047162042002, 5.464212476537451],
  [-73.63781532876806, 5.465438783356904],
  [-73.64085207830566, 5.462702093652553],
  [-73.64602485587406, 5.462868355128241],
  [-73.64912266512673, 5.465709821151517],
  [-73.6561899749635, 5.465825381994176],
  [-73.65723251560769, 5.470509354326958],
  [-73.65801818010762, 5.476390656979907],
  [-73.65781756635845, 5.479192998932239],
  [-73.65912509662625, 5.481158664109053],
  [-73.66203816792087, 5.481889477368545],
  [-73.66612629016257, 5.486789202621546],
  [-73.66654519403754, 5.491079902497473],
  [-73.66416920556402, 5.496249778838152],
  [-73.66971805426193, 5.50092942686844],
  [-73.67112118958694, 5.50369357157863],
  [-73.67219015228784, 5.505477590677271],
  [-73.67203246103118, 5.508204802319209],
  [-73.67433386062551, 5.508948429498886],
  [-73.67837150990982, 5.506386891157447],
  [-73.68836818298882, 5.507938922197455],
  [-73.69078359103885, 5.509672992066332],
  [-73.69287340889468, 5.510578988501879],
  [-73.69757143490644, 5.509974049757509],
  [-73.70076419773389, 5.511266491880372],
  [-73.70292778588581, 5.513244108396179],
  [-73.70473373229343, 5.51367141324693],
  [-73.70590574229303, 5.51585931795014],
  [-73.70705598534251, 5.519865153349609],
  [-73.71068561510506, 5.524939860751693],
  [-73.71232032267025, 5.525239623679089]
];

// COORDENADAS CUENCA ALTA
const coordenadasCuencaAlta = [
  [-73.93623414762436, 5.235466935822026],
  [-73.93666121932529, 5.241963212443441],
  [-73.92744508324395, 5.24612598969546],
  [-73.91924551113205, 5.248867390628062],
  [-73.91838347789361, 5.249013717344314],
  [-73.91113459490859, 5.253353975149253],
  [-73.90713329911497, 5.25623921796692],
  [-73.90648868155256, 5.259361690038293],
  [-73.90541771549209, 5.263921309979457],
  [-73.90119280070553, 5.266375005579641],
  [-73.89984276509732, 5.269640854611081],
  [-73.8993887814979, 5.272816623793591],
  [-73.88980696144193, 5.275301013035161],
  [-73.87973924834812, 5.276001855243456],
  [-73.87688261348949, 5.278165002557371],
  [-73.87516847213668, 5.283326612632854],
  [-73.87276083304693, 5.28449999177094],
  [-73.87217277866516, 5.284975226213171],
  [-73.86637309492392, 5.287002510282836],
  [-73.86547108643504, 5.291997591085221],
  [-73.8593461303343, 5.295123138079529],
  [-73.84712137025672, 5.293636527642257],
  [-73.84368387786965, 5.294916174187839],
  [-73.83309980511659, 5.292086648454649],
  [-73.82550381287713, 5.297049062603936],
  [-73.82610470906675, 5.300357916016733],
  [-73.82249408751566, 5.30224015234017],
  [-73.81698980174269, 5.304306272407367],
  [-73.81237339523658, 5.305473145096887],
  [-73.80857832024535, 5.308706173180025],
  [-73.80146305628799, 5.316090215512833],
  [-73.79591866493125, 5.323446637276544],
  [-73.79427189572611, 5.325367397290451],
  [-73.79081051310224, 5.332397502423656],
  [-73.78075046311936, 5.335923616048012],
  [-73.77181709050295, 5.336050205873168],
  [-73.76942372388498, 5.334891534084728],
  [-73.76957164348816, 5.350768193627051],
  [-73.7781693904527, 5.352283212832543],
  [-73.78385002877418, 5.358402570442616],
  [-73.78464777473401, 5.359501101024156],
  [-73.79061883582212, 5.362867694495686],
  [-73.79475788901782, 5.362347818290941],
  [-73.79917388091569, 5.367045289383149],
  [-73.80633432301704, 5.362766345505717],
  [-73.81275298071947, 5.359068338692654],
  [-73.81806378909742, 5.362228804075297],
  [-73.82292954766973, 5.36682945334508],
  [-73.82418743398745, 5.368182698857352],
  [-73.82746582816779, 5.36907344164748],
  [-73.83887485615502, 5.372167858180511],
  [-73.87094562400962, 5.395795224965646],
  [-73.87352330974484, 5.396192762352737],
  [-73.88918544323941, 5.379374779065885],
  [-73.89578860023757, 5.37881517430257],
  [-73.91158306031808, 5.381457014081364],
  [-73.92526672477754, 5.364327532318068],
  [-73.94113564103961, 5.375695431714577],
  [-73.94637198992504, 5.374199942067139],
  [-73.95086902869524, 5.372515981168681],
  [-73.95456679471364, 5.363979574974223],
  [-73.95959344644544, 5.357718667311479],
  [-73.96202538310116, 5.358762439815945],
  [-73.96303235881992, 5.358864515826928],
  [-73.96483017109027, 5.356644266994531],
  [-73.96962307679217, 5.350126089218838],
  [-73.97265570239601, 5.34733899185784],
  [-73.97558194886939, 5.342390343773665],
  [-73.97832022126357, 5.338178131416925],
  [-73.98013003336746, 5.334063539581115],
  [-73.98073577406328, 5.32972990558656],
  [-73.98088596748306, 5.325081620912441],
  [-73.98138053242171, 5.322601038299491],
  [-73.98105609783529, 5.320193172549158],
  [-73.97706290187948, 5.316094948107903],
  [-73.97373805694404, 5.314702315680694],
  [-73.97027540381558, 5.30945477631308],
  [-73.96651816162645, 5.303871469708268],
  [-73.96499811103045, 5.301532401174173],
  [-73.96646442196794, 5.298245019560586],
  [-73.97113879396376, 5.299413913468736],
  [-73.97785402263015, 5.293582462739013],
  [-73.9780851242197, 5.289734393533142],
  [-73.97747970022226, 5.283060311508942],
  [-73.97064499011907, 5.276139440800217],
  [-73.97369769669409, 5.264876833051618],
  [-73.9728753913575, 5.263004654281989],
  [-73.9768355733604, 5.25186441588355],
  [-73.9817903895771, 5.251823679971432],
  [-73.98575236622079, 5.243255601108126],
  [-73.98985014063135, 5.241014449381831],
  [-73.992178558655, 5.231950751794627],
  [-73.98184130633805, 5.225883136958447],
  [-73.98121297925771, 5.222793617973981],
  [-73.97800409441403, 5.22047186456432],
  [-73.97750849417321, 5.217473078098251],
  [-73.9741604300276, 5.214441830416384],
  [-73.97264569557385, 5.210912058812607],
  [-73.96360254640851, 5.213996333077783],
  [-73.95570386921574, 5.21629658043647],
  [-73.9511200107174, 5.224925034396453],
  [-73.94748598758846, 5.223910828698505],
  [-73.94584997499462, 5.227360343128901],
  [-73.94465850665387, 5.229218115543331],
  [-73.94376248986489, 5.233232983863334],
  [-73.93737500896123, 5.235075222470932],
  [-73.93623414762436, 5.235466935822026]
];

// 🗺️ Inicializar el mapa con límites estrictos
map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/satellite-streets-v12',
  center: [-73.833, 5.31],
  zoom: 11,
  pitch: 45,
  bearing: -20,
  maxBounds: calcularLimitesCuenca() // 🔒 LIMITES ESTRICTOS
});

// 🔒 Calcular límites que cubran ambas cuencas
function calcularLimitesCuenca() {
  const todasCoordenadas = [...coordenadasCuencaCompleta, ...coordenadasCuencaAlta];
  const lngs = todasCoordenadas.map(coord => coord[0]);
  const lats = todasCoordenadas.map(coord => coord[1]);
  
  return [
    [Math.min(...lngs) - 0.02, Math.min(...lats) - 0.02], // Suroeste
    [Math.max(...lngs) + 0.02, Math.max(...lats) + 0.02]  // Noreste
  ];
}

// ⚪ Polígonos de las cuencas
map.on('load', async () => {
  console.log('Mapa cargado, agregando polígonos...');
  
  // CUENCA COMPLETA (más grande)
  const geojsonCompleta = {
    type: 'FeatureCollection',
    features: [{
      type: 'Feature',
      geometry: { type: 'Polygon', coordinates: [coordenadasCuencaCompleta] },
      properties: { name: 'Cuenca Completa Ubaté' }
    }]
  };

  // CUENCA ALTA (más pequeña)
  const geojsonAlta = {
    type: 'FeatureCollection',
    features: [{
      type: 'Feature',
      geometry: { type: 'Polygon', coordinates: [coordenadasCuencaAlta] },
      properties: { name: 'Cuenca Alta Ubaté' }
    }]
  };

  // Agregar fuentes
  map.addSource('cuenca-completa', { type: 'geojson', data: geojsonCompleta });
  map.addSource('cuenca-alta', { type: 'geojson', data: geojsonAlta });

  // Capa de relleno - Cuenca Completa
  map.addLayer({
    id: 'cuenca-completa-relleno',
    type: 'fill',
    source: 'cuenca-completa',
    paint: {
      'fill-color': '#16a085',
      'fill-opacity': 0.15
    }
  });

  // Capa de línea - Cuenca Completa
  map.addLayer({
    id: 'cuenca-completa-linea',
    type: 'line',
    source: 'cuenca-completa',
    paint: {
      'line-color': '#16a085',
      'line-width': 2,
      'line-opacity': 0.6
    }
  });

  // Capa de relleno - Cuenca Alta
  map.addLayer({
    id: 'cuenca-alta-relleno',
    type: 'fill',
    source: 'cuenca-alta',
    paint: {
      'fill-color': '#ff6b6b',
      'fill-opacity': 0.2
    }
  });

  // Capa de línea - Cuenca Alta
  map.addLayer({
    id: 'cuenca-alta-linea',
    type: 'line',
    source: 'cuenca-alta',
    paint: {
      'line-color': '#ff6b6b',
      'line-width': 3,
      'line-opacity': 0.8
    }
  });

  console.log('Polígonos agregados, cargando imágenes...');
  
  // Cargar imágenes desde Supabase
  await cargarImagenes();
});

// 📍 Cargar imágenes y agregar marcadores
async function cargarImagenes() {
  console.log('Iniciando carga de imágenes desde Supabase...');
  
  try {
    const { data, error } = await supabase.from('imagenes').select('*');
    
    if (error) {
      console.error('Error cargando imágenes:', error);
      return;
    }

    console.log('Imágenes cargadas de Supabase:', data);

    // Limpiar marcadores anteriores
    marcadores.forEach(marker => marker.remove());
    marcadores = [];

    let imagenesConCoordenadas = 0;
    let imagenesPublicadas = 0;

    data.forEach(img => {
      console.log('Procesando imagen:', img);
      
      // Verificar si tiene coordenadas
      if (img.lat && img.lng) {
        imagenesConCoordenadas++;
        console.log(`Imagen con coordenadas: ${img.planta_id} - Lat: ${img.lat}, Lng: ${img.lng}`);
      }

      // Agregar marcador al mapa si tiene coordenadas y está publicada
      if (img.lat && img.lng && img.estado === 'publicada') {
        imagenesPublicadas++;
        
        // ✅ CORREGIDO: Usar url_imagen en lugar de imagen_url
        const imageUrl = img.url_imagen || 'https://via.placeholder.com/300x200/4a7c59/ffffff?text=Imagen+no+disponible';
        
        console.log(`Agregando marcador para: ${img.planta_id} en ${img.lat}, ${img.lng}`);
        
        const marker = new mapboxgl.Marker({
          color: '#1db954'
        })
          .setLngLat([img.lng, img.lat])
          .setPopup(
            new mapboxgl.Popup({ offset: 25 })
              .setHTML(`
                <div style="max-width: 300px; padding: 10px;">
                  <img src="${imageUrl}" alt="Imagen" 
                       style="width: 100%; border-radius: 8px; margin-bottom: 10px; height: 150px; object-fit: cover;" 
                       onerror="this.src='https://via.placeholder.com/300x200/4a7c59/ffffff?text=Imagen+no+disponible'" />
                  <h4 style="margin: 0 0 8px 0; color: #333; font-size: 16px;">
                    ${img.planta_id || 'Imagen de la Cuenca'}
                  </h4>
                  ${img.description ? `
                    <p style="margin: 0 0 8px 0; color: #666; font-size: 14px; line-height: 1.4;">
                      ${img.description}
                    </p>
                  ` : ''}
                  <p style="margin: 0; color: #888; font-size: 12px;">
                    📍 ${img.lat?.toFixed(6)}, ${img.lng?.toFixed(6)}
                  </p>
                  <p style="margin: 5px 0 0 0; color: #999; font-size: 11px;">
                    Subido por: ${img.nombre_usuario || 'Anónimo'}
                  </p>
                </div>
              `)
          )
          .addTo(map);

        marcadores.push(marker);
      }
    });

    console.log(`Resumen: ${data.length} imágenes totales, ${imagenesConCoordenadas} con coordenadas, ${imagenesPublicadas} publicadas y agregadas al mapa`);
    console.log(`Marcadores agregados: ${marcadores.length}`);

    // Si no hay marcadores, mostrar mensaje
    if (marcadores.length === 0) {
      console.warn('No se encontraron imágenes con coordenadas y estado publicada');
    }

  } catch (error) {
    console.error('Error en cargarImagenes:', error);
  }
}

// 🔄 Verificar si hay un marcador específico en localStorage
window.addEventListener('load', function() {
  const marcadorGuardado = localStorage.getItem('marcador_actual');
  if (marcadorGuardado) {
    const marcador = JSON.parse(marcadorGuardado);
    console.log('Marcador desde admin:', marcador);
    
    // Centrar el mapa en el marcador
    map.flyTo({
      center: [marcador.lng, marcador.lat],
      zoom: 15,
      essential: true
    });

    // Limpiar localStorage después de usar
    localStorage.removeItem('marcador_actual');
  }
});

// Función para recargar imágenes (puedes llamarla desde la consola para debug)
window.recargarImagenes = cargarImagenes;